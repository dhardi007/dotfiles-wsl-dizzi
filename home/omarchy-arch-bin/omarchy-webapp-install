#!/bin/bash
# /003   omarchy-webapp-install

# Colores y formato
RESET='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'
CYAN='\033[96m'
GREEN='\033[92m'
YELLOW='\033[93m'
RED='\033[91m'
BLUE='\033[94m'
MAGENTA='\033[95m'

check_deps() {
  for cmd in gum curl; do
    if ! command -v "$cmd" &>/dev/null; then
      echo -e "${RED}${BOLD}âŒ Error:${RESET} ${YELLOW}$cmd${RESET} no estÃ¡ instalado"
      return 1
    fi
  done
  return 0
}

create_webapp() {
  local APP_NAME="$1"
  local APP_URL="$2"
  local ICON_REF="$3"
  local BROWSER="${4:-brave}" # Brave por defecto

  echo -e "${BLUE}ðŸ”„ Creando webapp:${RESET} ${BOLD}$APP_NAME${RESET}"

  # Validar
  [[ -z "$APP_NAME" || -z "$APP_URL" ]] && {
    echo -e "${RED}${BOLD}âŒ Error:${RESET} Se necesitan nombre y URL"
    exit 1
  }

  # Directorio de iconos
  ICON_DIR="$HOME/.local/share/icons"
  mkdir -p "$ICON_DIR"

  # Icono
  ICON_PATH=""
  if [[ -n "$ICON_REF" ]] && [[ "$ICON_REF" =~ ^https?:// ]]; then
    ICON_FILE="$ICON_DIR/${APP_NAME// /_}.png"
    echo -e "${YELLOW}ðŸ“¥ Descargando icono...${RESET}"
    if curl -sL -o "$ICON_FILE" "$ICON_REF"; then
      ICON_PATH="$ICON_FILE"
      echo -e "${GREEN}âœ… Icono descargado${RESET}"
    else
      ICON_PATH="web-browser"
      echo -e "${YELLOW}âš ï¸  Usando icono por defecto${RESET}"
    fi
  else
    ICON_PATH="web-browser"
  fi

  # COMANDO EXEC CORREGIDO - Â¡ESTO ES LA CLAVE!
  # Para navegadores Chromium: usar --app para modo aplicaciÃ³n
  # Para Firefox: usar --new-window para ventana dedicada

  local EXEC_COMMAND=""

  case "$BROWSER" in
  brave | chrome | chromium | edge | vivaldi | opera)
    # Modo aplicaciÃ³n REAL (sin UI de navegador)
    EXEC_COMMAND="$BROWSER --app=\"$APP_URL\""
    ;;
  firefox)
    # Firefox no tiene --app, pero podemos usar ventana dedicada
    # Extraer dominio para perfil Ãºnico
    DOMAIN=$(echo "$APP_URL" | sed -E 's|^https?://([^/]+).*|\1|' | tr -cd '[:alnum:]')
    EXEC_COMMAND="sh -c 'if ! pgrep -f \"firefox.*-P.*$DOMAIN\" >/dev/null; then firefox -CreateProfile \"$DOMAIN\" 2>/dev/null; fi; firefox -P \"$DOMAIN\" --new-window \"$APP_URL\"'"
    notify-send "ðŸ“± Para cambiar de perfil de firefox: îŠ… firefox -ProfileManager"
    ;;
  *)
    # Fallback: xdg-open
    EXEC_COMMAND="sh -c 'xdg-open \"$APP_URL\"'"
    ;;
  esac

  # Crear archivo .desktop
  DESKTOP_FILE="$HOME/.local/share/applications/${APP_NAME// /_}.desktop"

  cat >"$DESKTOP_FILE" <<DESKTOP_ENTRY
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=Open $APP_NAME
Exec=$EXEC_COMMAND
Terminal=false
Type=Application
Icon=$ICON_PATH
Categories=Network;
StartupNotify=true
StartupWMClass=${APP_NAME// /_}
DESKTOP_ENTRY

  chmod +x "$DESKTOP_FILE"

  echo -e "${GREEN}${BOLD}âœ… Webapp creada:${RESET} ${CYAN}$DESKTOP_FILE${RESET}"
  echo -e "${MAGENTA}ðŸŽ¯ Ejecuta desde tu menÃº o con:${RESET}"
  echo -e "   ${DIM}$BROWSER --app=\"$APP_URL\"${RESET}"

  # Actualizar base de datos
  command -v update-desktop-database &>/dev/null &&
    update-desktop-database ~/.local/share/applications
}

# Modo interactivo mejorado
interactive_mode() {
  echo -e "\n${CYAN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
  echo -e "${CYAN}${BOLD}â•‘      ðŸ“± CREAR WEBAPP COMO APLICACIÃ“N             â•‘${RESET}"
  echo -e "${CYAN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"

  echo -e "${DIM}Esto crearÃ¡ una aplicaciÃ³n NATIVA para un sitio web,"
  echo -e "con su propio icono en el menÃº y ventana dedicada.${RESET}\n"

  # Nombre
  APP_NAME=$(gum input --prompt "ðŸ“ Nombre de la aplicaciÃ³n: " --placeholder "Ej: Claude AI, WhatsApp Web" --value "")
  [[ -z "$APP_NAME" ]] && {
    echo -e "${RED}${BOLD}âŒ Nombre requerido${RESET}"
    exit 1
  }

  # URL
  APP_URL=$(gum input --prompt "ðŸŒ URL del sitio: " --placeholder "https://ejemplo.com" --value "")
  [[ -z "$APP_URL" ]] && {
    echo -e "${RED}${BOLD}âŒ URL requerida${RESET}"
    exit 1
  }

  # Navegador
  echo -e "\n${BLUE}ðŸŒ Â¿En quÃ© navegador quieres abrirlo?${RESET}"
  echo -e "${DIM}   (Brave/Chrome abren como APLICACIÃ“N, Firefox como ventana dedicada)${RESET}"
  BROWSER=$(gum choose \
    "brave  (recomendado - modo aplicaciÃ³n)" \
    "chrome (modo aplicaciÃ³n)" \
    "firefox (ventana dedicada)" \
    "chromium (modo aplicaciÃ³n)" \
    --header "Selecciona navegador" | cut -d' ' -f1)

  # Icono
  echo -e "\n${MAGENTA}ðŸŽ¨ Â¿Quieres un icono personalizado?${RESET}"
  echo -e "${DIM}1. SÃ­, descargar de una URL"
  echo -e "2. No, usar icono por defecto${RESET}"

  ICON_CHOICE=$(gum choose "1" "2" --header "OpciÃ³n de icono")

  ICON_REF=""
  if [[ "$ICON_CHOICE" == "1" ]]; then
    ICON_REF=$(gum input --prompt "ðŸ“Ž URL del icono (PNG): " \
      --placeholder "https://.../dashboard-icons/png/claude-ai.png ï¡ Recomiendo usar Vicinae Raycast > Dashboard Icons Extension para buscar iconos" \
      --value "")
  fi

  # Confirmar
  echo -e "\n${CYAN}${BOLD}ðŸ“‹ Resumen:${RESET}"
  echo -e "   ${BOLD}Nombre:${RESET}    ${GREEN}$APP_NAME${RESET}"
  echo -e "   ${BOLD}URL:${RESET}       ${BLUE}$APP_URL${RESET}"
  echo -e "   ${BOLD}Navegador:${RESET} ${YELLOW}$BROWSER${RESET}"
  [[ -n "$ICON_REF" ]] && echo -e "   ${BOLD}Icono:${RESET}     ${MAGENTA}Personalizado${RESET}" || echo -e "   ${BOLD}Icono:${RESET}     ${DIM}Por defecto${RESET}"

  gum confirm "Â¿Crear aplicaciÃ³n?" || exit 0

  create_webapp "$APP_NAME" "$APP_URL" "$ICON_REF" "$BROWSER"
}

main() {
  check_deps || exit 1

  if [[ "$#" -lt 2 ]]; then
    interactive_mode
  else
    create_webapp "$@"
  fi
}

main "$@"
